package router

import (
	itemsHandler "ShoppingList-Backend/cmd/api/handlers/items"
	listsHandler "ShoppingList-Backend/cmd/api/handlers/lists"
	"ShoppingList-Backend/pkg/application"
	"ShoppingList-Backend/pkg/middleware"
	"ShoppingList-Backend/pkg/websocket"
	"net/http"

	"github.com/gorilla/mux"

	// http-swagger middleware
	httpSwagger "github.com/swaggo/http-swagger"

	// docs are generated by Swag CLI
	_ "ShoppingList-Backend/api"
)

func PrivateRoutes(app *application.Application, r *mux.Router) {
	apiV1 := r.PathPrefix("/api/v1").Subrouter()

	apiV1.Use(middleware.NewZapLogger(middleware.Config{RedactedQueryParams: []string{"Authorization"}}))

	// Items
	items := apiV1.PathPrefix("/items").Subrouter()
	items.Use(middleware.JWTProtected(app.Cfg))
	items.HandleFunc("", itemsHandler.GetItems(app)).Methods("GET")
	items.HandleFunc("", itemsHandler.CreateItem(app)).Methods("POST")
	items.HandleFunc("/{id}", itemsHandler.UpdateItem(app)).Methods("PUT")
	items.HandleFunc("/{id}", itemsHandler.DeleteItem(app)).Methods("DELETE")

	// Lists

	lists := apiV1.PathPrefix("/lists").Subrouter()
	lists.Use(middleware.JWTProtected(app.Cfg))

	listHub := websocket.NewHub()
	go listHub.Run()
	listsWs := lists.PathPrefix("/ws").Subrouter()
	listsWs.HandleFunc("/default", listsHandler.WsOnListChanges(listHub, app))

	lists.HandleFunc("", listsHandler.GetLists(app)).Methods("GET")
	lists.HandleFunc("/default", listsHandler.GetDefaultList(app)).Methods("GET")
	lists.HandleFunc("", listsHandler.CreateList(app)).Methods("POST")
	lists.HandleFunc("/{id}", listsHandler.UpdateList(listHub, app)).Methods("PUT")
	lists.HandleFunc("/{id}/default", listsHandler.SetDefaultList(app)).Methods("PUT")
	lists.HandleFunc("/{id}", listsHandler.DeleteList(app)).Methods("DELETE")
	lists.HandleFunc("/{id}/items/{itemId}", listsHandler.AddItemToList(listHub, app)).Methods("POST")
	lists.HandleFunc("/{id}/items/{listItemId}", listsHandler.UpdateListItem(listHub, app)).Methods("PUT")
	lists.HandleFunc("/{id}/items/{listItemId}", listsHandler.RemoveItemFromList(listHub, app)).Methods("DELETE")

}

func SwaggerRoute(app *application.Application, r *mux.Router) {
	r.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		http.Redirect(w, r, r.URL.Opaque+"/swagger/index.html", http.StatusMovedPermanently)
	}).Methods("GET")
	r.PathPrefix("/swagger").Handler(httpSwagger.Handler(
		httpSwagger.DeepLinking(true),
		httpSwagger.DocExpansion("none"),
		httpSwagger.DomID("#swagger-ui"),
	))
}
